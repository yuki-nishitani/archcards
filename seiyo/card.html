<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>archcards</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 0; background:#fafafa; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }

    .card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 14px;
      padding: 12px;
      overflow: hidden;
      user-select: none;
    }

    /* 画像共通：縦長は max-height で抑える */
    .img {
      width: 100%;
      height: auto;
      max-height: 40vh;     /* ←あなたの指定 */
      object-fit: contain;
      border-radius: 8px;
      display:block;
      background: #fff;
    }

    .stack .img + .img { margin-top: 10px; } /* 表は縦並び */

    .info {
      padding: 12px;
      border-radius: 10px;
      background:#f2f4f7;
    }
    .row { margin: 6px 0; line-height: 1.35; }
    .label { color:#555; font-weight: 500; margin-right: 6px; }

    /* 裏面：横並び */
    .thumbs {
      margin-top: 12px;
      display: flex;
      gap: 5px;
      align-items: flex-start;
    }
    .thumb {
      flex: 1 1 0;
      max-width: 50%;
    }
    .thumb img {
      width: 100%;
      height: auto;
      max-height: 40vh;     /* ←同じ制限 */
      object-fit: contain;
      border-radius: 5px;
      display:block;
      background:#fff;
    }

    .hint { color:#666; font-size: 13px; margin-top: 10px; }


    /* 建築名（名称）だけ見出しっぽく */
    #title{
      font-size: 1.4em;        /* 大きさ：好みで 1.25〜1.6em */
      font-weight: 600;        /* 太さ */
      letter-spacing: 0.02em;  /* 少しだけ間をあけて見出し感 */
      display: inline-block;
      margin-bottom: 6px;      /* 次の行との間 */
    }

    /* （任意）名称の行だけ詰める/整えるなら */
    .row:first-child{
      margin-top: 0;
    }


    /* 表⇄裏 切替（高さは内容に合わせて自然に変わる） */
    .face { display: none; }
    .card.show-front .front { display: block; }
    .card.show-back  .back  { display: block; }

    .topbar{
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }

    .modebtn{
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 12px;
      background: #fff;
      font-weight: 700;
      cursor: pointer;
      user-select: none;

      font-size: 15px; 
    }

    .modebtn:active{
      transform: translateY(1px);
    }

    .nav{
      margin-top: 12px;
      display: flex;
      gap: 10px;
    }

    .navbtn{
      flex: 1 1 0;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 12px;
      background: #fff;
      font-weight: 700;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }

    /* aタグ版の見た目をボタンに揃える */
    .navlink{
      text-decoration: none;
      color: #111;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .navbtn:active{
      transform: translateY(1px);
    }

  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <button class="modebtn" id="modeBtn" type="button">通常モード</button>
    </div>
    
    <div class="card show-front" id="card">
      <!-- FRONT: 流し見（画像だけ縦並び） -->
      <div class="face front stack">
        <img class="img" id="img1" alt="image 1" />
        <img class="img" id="img2" alt="image 2" />
        <div class="hint">タップ：詳細 / 左右フリック：次・前</div>
      </div>

      <!-- BACK: 文字（上） + 画像（下で横並び） -->
      <div class="face back">
        <div class="info">
          <div class="row title-row"><span id="title"></span></div>
          <div class="row"><span class="label">年代:</span><span id="year"></span></div>
          <div class="row"><span class="label">様式:</span><span id="style"></span></div>
          <div class="row"><span class="label">建築家:</span><span id="architect"></span></div>
          <div class="row"><span class="label">場所:</span><span id="location"></span></div>
          <div class="row"><span class="label">メモ:</span><span id="desc"></span></div>
        </div>

        <div class="thumbs">
          <div class="thumb"><img id="img1b" alt="thumb 1" /></div>
          <div class="thumb"><img id="img2b" alt="thumb 2" /></div>
        </div>

        <div class="hint">タップ：戻る / 左右フリック：次・前</div>
      </div>

      <div class="nav">
        <button class="navbtn" id="btnPrev" type="button">前へ</button>
        <a class="navbtn navlink" id="btnList" href="list.html">一覧へ</a>
        <button class="navbtn" id="btnNext" type="button">次へ</button>
      </div>

    </div>
  </div>

<script>
  const DATA_JSON = "https://archicard-api.yuki-548.workers.dev/api/items?collection=seiyo";
  let items = [];
  let idx = 0;

  let randomMode = false;
  let randHistory = []; // ランダムで辿った履歴（前へで戻る用）



  const card = document.getElementById("card");
  // URLパラメータ (?id=ise など) を読む
  const params = new URLSearchParams(location.search);
  const startId = params.get("id");


  function $(id) { return document.getElementById(id); }

  function showFront() {
    card.classList.add("show-front");
    card.classList.remove("show-back");
  }
  function showBack() {
    card.classList.add("show-back");
    card.classList.remove("show-front");
  }
  function isBack() {
    return card.classList.contains("show-back");
  }

  function render(i) {
    if (!items.length) return;

    idx = (i + items.length) % items.length;
    const item = items[idx];

    // front images
    $("img1").src = item.images?.[0] ?? "";
    $("img2").src = item.images?.[1] ?? "";

    // back text
    $("title").textContent = item.title ?? "";
    $("year").textContent  = item.year ?? "";
    $("style").textContent = item.style ?? "";
    $("architect").textContent = item.architect ?? "";
    $("location").textContent  = item.location ?? "";
    $("desc").textContent  = item.desc ?? "";

    // back thumbs (same images)
    $("img1b").src = item.images?.[0] ?? "";
    $("img2b").src = item.images?.[1] ?? "";

    // ページ切替時は表に戻す（好みで：詳細に留めたいなら消す）
    showFront();
  }

  function renderById(id){
   const i = items.findIndex(it => it.id === id);
   if (i >= 0) render(i);
   else render(0); // 見つからなければ先頭
  }


  function next() {
    if (!items.length) return;

    if (!randomMode) {
      render(idx + 1);
      return;
    }

    // ランダム：現在と同じにならないようにする（要素数1なら同じでもOK）
    randHistory.push(idx);
    if (items.length === 1) { render(idx); return; }

    let j = idx;
    while (j === idx) {
      j = Math.floor(Math.random() * items.length);
    }
    render(j);
  }

  function prev() {
    if (!items.length) return;

    if (!randomMode) {
      render(idx - 1);
      return;
    }

    // ランダム：履歴を戻る
    if (randHistory.length > 0) {
      render(randHistory.pop());
    } else {
      // 履歴がないときは通常の prev にフォールバック（好みで消してOK）
      render(idx - 1);
    }
  }


  // --- Buttons: prev/next/list ---
  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const btnList = document.getElementById("btnList");

  btnPrev.addEventListener("click", (e) => { e.stopPropagation(); prev(); });
  btnNext.addEventListener("click", (e) => { e.stopPropagation(); next(); });

  // 一覧へ：カードの click (表裏反転) が発火しないようにする
  btnList.addEventListener("click", (e) => { e.stopPropagation(); });

  const modeBtn = document.getElementById("modeBtn");

  function updateModeUI(){
    modeBtn.textContent = randomMode ? "ランダムモード" : "通常モード";
  }

  modeBtn.addEventListener("click", (e) => {
    e.stopPropagation();         // カードの表裏反転を誤発火させない
    randomMode = !randomMode;
    randHistory = [];            // モード切替時に履歴リセット（破綻防止）
    updateModeUI();
  });

  updateModeUI();


  async function load() {
    const res = await fetch(DATA_JSON, { cache: "no-store" });
    if (!res.ok) throw new Error(`data.json load failed: ${res.status}`);
    items = await res.json();
    if (!Array.isArray(items) || items.length === 0) throw new Error("data.json is empty");

    if (startId) {
      renderById(startId);
    } else {
      render(0);
    }
  }

  // --- Tap: front<->back ---
  let justSwiped = false;

  card.addEventListener("click", () => {
    if (justSwiped) return;
    if (isBack()) showFront();
    else showBack();
  });

  // --- Swipe: prev/next ---
  let startX = 0, startY = 0, startT = 0;
  let tracking = false;

  card.addEventListener("touchstart", (e) => {
    if (!e.touches || e.touches.length !== 1) return;
    const t = e.touches[0];
    startX = t.clientX;
    startY = t.clientY;
    startT = Date.now();
    tracking = true;
    justSwiped = false;
  }, { passive: true });

  card.addEventListener("touchend", (e) => {
    if (!tracking) return;
    tracking = false;

    const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
    if (!t) return;

    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    const dt = Date.now() - startT;

    const MIN_X = 60;
    const MAX_Y = 60;
    const MAX_TIME = 600;

    const isSwipe = (Math.abs(dx) >= MIN_X) && (Math.abs(dy) <= MAX_Y) && (dt <= MAX_TIME);
    if (!isSwipe) return;

    justSwiped = true;
    setTimeout(() => { justSwiped = false; }, 250);

    if (dx < 0) next();
    else prev();
  }, { passive: true });

  // PC確認用
  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowRight") next();
    if (e.key === "ArrowLeft") prev();
    if (e.key === "Enter") { if (isBack()) showFront(); else showBack(); }
  });

  load().catch(err => {
    console.error(err);
    alert("data.json の読み込みに失敗しました。Live Server で開いているか、data.json が同じフォルダにあるか確認してください。");
  });
</script>
</body>
</html>
